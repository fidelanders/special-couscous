name: Newman Tests

on: [push, pull_request]

jobs:
  newman:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      # Run Newman but continue even if tests fail
      - name: Run collection with Newman
        run: |
          mkdir -p reports
          npx newman run ./collection.json -e ./environment.json -r cli,htmlextra,json \
            --reporter-htmlextra-export ./reports/api-report.html \
            --reporter-json-export ./reports/api-report.json
        continue-on-error: true

      # Always upload HTML report
      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-htmlextra-html-report
          path: ./reports/api-report.html

      # Always upload JSON report
      - name: Upload JSON report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-json-report
          path: ./reports/api-report.json

      # Always show test summary in GitHub Actions summary, grouped by request name
      - name: Generate and display Newman summary
        if: always()
        run: |
          echo "## ðŸ§ª Newman Test Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f ./reports/api-report.json ]; then
            total=$(jq '.run.stats.tests.total' ./reports/api-report.json)
            failed=$(jq '.run.stats.tests.failed' ./reports/api-report.json)
            passed=$((total - failed))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Tests:** $total" >> $GITHUB_STEP_SUMMARY
            echo "**Passed:** âœ… $passed" >> $GITHUB_STEP_SUMMARY
            echo "**Failed:** âŒ $failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Group failed assertions by request name
            if [ "$failed" -gt 0 ]; then
              echo "**Failed Tests:**" >> $GITHUB_STEP_SUMMARY
              jq -r '
                .run.executions[]
                | select(.assertions[]? | .error != null)
                | .item.name as $req
                | .assertions[]
                | select(.error != null)
                | "- " + $req + ": " + .error.test
              ' ./reports/api-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            echo "[ðŸ“„ Download full HTML report](./reports/api-report.html)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No JSON report found to summarize." >> $GITHUB_STEP_SUMMARY
          fi
