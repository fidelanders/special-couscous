name: Newman Tests

on: [push, pull_request]

jobs:
  newman:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repo
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # Run Newman using npm script
      - name: Run Newman collection
        run: |
          mkdir -p $GITHUB_WORKSPACE/reports
          npm run test:newman
        continue-on-error: true

      # Debug: List reports folder
      - name: List report files
        run: ls -la $GITHUB_WORKSPACE/reports

      # Upload HTML report
      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-htmlextra-html-report
          path: $GITHUB_WORKSPACE/reports/api-report.html
          if-no-files-found: warn

      # Upload JSON report
      - name: Upload JSON report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-json-report
          path: $GITHUB_WORKSPACE/reports/api-report.json
          if-no-files-found: warn

      # Display summary (grouped failed tests)
      - name: Generate and display Newman summary
        if: always()
        run: |
          echo "## ðŸ§ª Newman Test Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f $GITHUB_WORKSPACE/reports/api-report.json ]; then
            total=$(jq '.run.stats.tests.total' $GITHUB_WORKSPACE/reports/api-report.json)
            failed=$(jq '.run.stats.tests.failed' $GITHUB_WORKSPACE/reports/api-report.json)
            passed=$((total - failed))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Tests:** $total" >> $GITHUB_STEP_SUMMARY
            echo "**Passed:** âœ… $passed" >> $GITHUB_STEP_SUMMARY
            echo "**Failed:** âŒ $failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$failed" -gt 0 ]; then
              echo "**Failed Tests:**" >> $GITHUB_STEP_SUMMARY
              jq -r '
                .run.executions[]
                | select(.assertions[]? | .error != null)
                | .item.name as $req
                | .assertions[]
                | select(.error != null)
                | "- " + $req + ": " + .error.test
              ' $GITHUB_WORKSPACE/reports/api-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            echo "[ðŸ“„ Download full HTML report](./reports/api-report.html)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No JSON report found to summarize." >> $GITHUB_STEP_SUMMARY
          fi
