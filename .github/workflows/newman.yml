name: Newman Tests

on: [push, pull_request]

jobs:
  newman:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repo
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Ensure reports folder exists
      - name: Create reports folder
        run: mkdir -p reports

      # 5ï¸âƒ£ Run Newman collection using package.json script
      - name: Run Newman collection
        run: npm run test:newman
        continue-on-error: true

      # 6ï¸âƒ£ Debug: list files in reports folder
      - name: Check reports folder
        run: ls -la reports

      # 7ï¸âƒ£ Upload HTML report artifact
      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-htmlextra-html-report
          path: reports/api-report.html
          if-no-files-found: warn

      # 8ï¸âƒ£ Upload JSON report artifact
      - name: Upload JSON report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-json-report
          path: reports/api-report.json
          if-no-files-found: warn

      # 9ï¸âƒ£ Display summary in GitHub Actions with emoji badges
      - name: Generate and display Newman summary
        if: always()
        run: |
          echo "## ðŸ§ª Newman Test Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/api-report.json ]; then
            total=$(jq '.run.stats.tests.total' reports/api-report.json)
            failed=$(jq '.run.stats.tests.failed' reports/api-report.json)
            passed=$((total - failed))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Tests:** $total" >> $GITHUB_STEP_SUMMARY
            echo "**Passed:** âœ… $passed" >> $GITHUB_STEP_SUMMARY
            echo "**Failed:** âŒ $failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Group failed assertions by request name with emoji badges
            if [ "$failed" -gt 0 ]; then
              echo "**Failed Tests:**" >> $GITHUB_STEP_SUMMARY
              jq -r '
                .run.executions[]
                | .item.name as $req
                | ($req + ":") as $reqName
                | .assertions[]
                | if .error != null then "- âŒ " + $reqName + " " + .error.test else empty end
              ' reports/api-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Show passed requests with badge
            echo "**Passed Requests:**" >> $GITHUB_STEP_SUMMARY
            jq -r '
              .run.executions[]
              | .item.name as $req
              | ($req + ":") as $reqName
              | .assertions[]
              | if .error == null then "- âœ… " + $reqName + " " + .assertion else empty end
            ' reports/api-report.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "[ðŸ“„ Download full HTML report](reports/api-report.html)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No JSON report found to summarize." >> $GITHUB_STEP_SUMMARY
          fi
